{"version":3,"file":"gridlist.js","sources":["webpack://@financier/injections/../../packages/utils/dom.ts","webpack://@financier/injections/../../packages/utils/wait.ts","webpack://@financier/injections/../../packages/utils/number.ts","webpack://@financier/injections/../../packages/utils/cacheable.ts","webpack://@financier/injections/../../packages/utils/data.ts","webpack://@financier/injections/./gridlist.ts","webpack://@financier/injections/./utils/resolver.ts"],"sourcesContent":["export interface Selective {\n  querySelector<E extends Element = Element>(selector: string): E | null\n  querySelectorAll<E extends Element = Element>(selector: string): NodeListOf<E>,\n}\n\n\nexport function selectBy(\n  selector: string,\n  from: Selective = document\n) {\n  return from.querySelector(selector);\n}\n\nexport function selectAll(\n  selector: string,\n  from: Selective = document\n) {\n  return from.querySelectorAll(selector);\n}\n\nexport function readTextContent(selector: string): string | null | undefined {\n  return selectBy(selector)?.textContent;\n}\n","import {readTextContent, selectBy} from './dom';\nimport {randomInt} from './number';\nimport {logger} from './log';\nimport {cacheable} from './cacheable';\n\nexport function waitForAvailable<T = any>(\n  tester: () => (T | Promise<T>),\n  timeout: number = -1,\n): Promise<Exclude<T, null | undefined | false | '' | 0>> {\n  return new Promise((resolve, reject) => {\n    const endAt = timeout > 0 ? Date.now() + timeout : -1;\n\n    function nextTask() {\n      setTimeout(test);\n    }\n\n    function onValue(value: any) {\n      if (value != null && value !== false) {\n        resolve(value as any);\n      } else if (endAt < 0 || Date.now() < endAt) {\n        nextTask();\n      } else {\n        reject('Timeout');\n      }\n    }\n\n    function test() {\n      const value: any = tester();\n      if (typeof value?.then === 'function') {\n        value.then(onValue, nextTask);\n      } else {\n        onValue(value);\n      }\n    }\n\n    test();\n  });\n}\n\nexport function waitForSelected(selector: string, timeout?: number) {\n  return waitForAvailable(() => selectBy(selector), timeout);\n}\n\nexport function waitForHasTextContent(\n  selector: string,\n  timeout?: number,\n): Promise<string> {\n  return waitForAvailable(() => readTextContent(selector)?.trim() || null, timeout);\n}\n\nexport async function waitForTimeout(minTimeout: number, maxTimeout: number = minTimeout): Promise<void> {\n  return new Promise((resolve) => {\n    const timeout = maxTimeout - minTimeout > 16 ? randomInt(minTimeout, maxTimeout) : 16;\n    // logger.trace('Waiting for timeout {} ms ...', timeout);\n    setTimeout(resolve, timeout);\n  });\n}\n\nconst IntervalBased = cacheable((second: number): [number, number] => {\n  const middle = second * 1000;\n  const min = Math.ceil(second / 5) * 1000;\n  const max = 2 * middle - min;\n  return [min, max];\n});\n\nexport async function waitAMomentOnTruth(isTruth: any = true, delaySeconds: number = 5): Promise<void> {\n  if (isTruth) {\n    let time = Math.max(1, delaySeconds);\n    time = Number.isNaN(time) ? 5 : time;\n    const [min, max] = IntervalBased(time);\n    return waitForTimeout(min, max);\n  }\n}","export function randomInt(min: number, max: number): number {\n  return Math.floor(Math.random() * (max - min)) + min;\n}\n\nexport function toRadix36String(value: number): string {\n  return value.toString(36);\n}\n\nexport function parseRadix36String(value: string): number {\n  return Number.parseInt(value, 36);\n}\n","export function cacheable<K extends string | number, V>(\n  resolver: (key: K) => V\n): (key: K) => V {\n  const caches: Record<number | string, any> = {};\n  return (k: K): V => {\n    let value = caches[k];\n    if (value) {\n      return value;\n    }\n    value = resolver(k);\n    caches[k] = value;\n    return value;\n  }\n}","export function appendJson(data: any, propertyKey: string): void {\n  window[propertyKey as any] = data;\n}","import {waitAMomentOnTruth, waitForAvailable, waitForSelected} from \"@shared/utils/wait\";\nimport {resolveGridlist, updateWaiting} from \"./utils/resolver\";\n\nconst first_td_anchor = '#table_wrapper-table .mywidth a[href*=\"//quote.eastmoney.com/unify/r/\"]';\nconst thead_td_list_all = '#table_wrapper-table thead th';\nconst tbody_tr_list_all = '#table_wrapper-table tbody tr';\nconst page_next_jumper = '#table_wrapper .next.paginate_button';\nconst page_latest_jumper = '#main-table_paginate .paginate_page a:last-child';\n\nfunction toClearText(content?: string | null): string {\n  return (content || '').replace(/&\\w{4};/g, '').trim();\n}\n\nasync function waitFirstTdAvailable(\n  hasHref: (href: string) => (boolean | Promise<void>)\n): Promise<true | void> {\n  return waitForAvailable(async () => {\n    const firstTd = $(first_td_anchor).get(0) as HTMLAnchorElement | null;\n    const href = firstTd?.href;\n    if (href) {\n      return !hasHref(href);\n    }\n  });\n}\n\nfunction readHeads() {\n  const heads: string[] = [];\n  $(thead_td_list_all).each(function () {\n    heads.push(toClearText(this.textContent));\n  });\n  return heads;\n}\n\nfunction readRecords(recordsList: Record<string, string>[], heads: string[]): void {\n  $(tbody_tr_list_all).each(function () {\n    const record: Record<string, string> = {};\n    $(this).find('td').each(function (idx) {\n      const anchors = $(this).find(\"a\");\n      if (anchors.length) {\n        const links: any[] = [];\n        anchors.map(function () {\n          const text = toClearText(this.textContent);\n          if (text) {\n            links.push({href: this.href, text});\n          }\n        });\n        if (links.length) {\n          record[heads[idx]] = links as any;\n        }\n      } else {\n        record[heads[idx]] = toClearText(this.textContent);\n      }\n    });\n    recordsList.push(record);\n  });\n}\n\nasync function jumpToNextPage() {\n  const jumper = await waitForSelected(page_next_jumper) as HTMLAnchorElement;\n  jumper.click();\n  return waitAMomentOnTruth();\n}\n\ninterface StockInfo {\n  code: string;\n  href: string;\n}\n\ninterface TypeRefs {\n  index: number;\n  max: number;\n  list: Record<string, string>[],\n  map: Map<string | undefined, StockInfo>\n}\n\nasync function readAll(\n  refs: TypeRefs\n): Promise<any> {\n  await waitFirstTdAvailable(href => refs.map.has(href));\n  const heads = readHeads();\n  readRecords(refs.list, heads);\n\n  $(first_td_anchor).each(function () {\n    const href = $(this).attr('href') || '';\n    const code = href.slice(href.lastIndexOf('.') + 1);\n    if (href && code) {\n      const info: StockInfo = {code, href};\n      refs.map.set(href, info);\n      refs.map.set(code, info);\n    }\n  });\n\n  updateWaiting(refs.index++);\n\n  if ($(page_latest_jumper).hasClass('current') || refs.index >= refs.max) {\n    return;\n  } else {\n    return await jumpToNextPage().then(() => readAll(refs));\n  }\n}\n\n$(async () => {\n  $('#body-main').on('click', (e) => {\n    e.stopPropagation();\n  });\n\n  const refs: TypeRefs = {\n    index: 0,\n    max: 1000,\n    list: [],\n    map: new Map(),\n  };\n\n  await readAll(refs);\n\n  resolveGridlist(refs.list);\n});","import {appendJson} from \"@shared/utils/data\";\n\nexport function resolveF1(data: any) {\n  appendJson(data, process.env.IM_F1_END_CLASS);\n}\n\nexport function resolveGridlist(data: any) {\n  appendJson(data, process.env.IM_GRIDLIST_END_CLASS);\n}\n\nexport function updateWaiting(data: any) {\n  appendJson(data, process.env.IM_GRIDLIST_WAITING_CLASS);\n}\n"],"names":["selectBy","selector","from","document","waitForAvailable","tester","timeout","Promise","resolve","reject","endAt","Date","nextTask","setTimeout","test","onValue","value","waitForTimeout","minTimeout","maxTimeout","min","Math","max","IntervalBased","cacheable","resolver","caches","k","second","waitAMomentOnTruth","isTruth","delaySeconds","time","Number","appendJson","data","propertyKey","window","first_td_anchor","toClearText","content","waitFirstTdAvailable","hasHref","firstTd","$","href","jumpToNextPage","jumper","readAll","refs","recordsList","heads","readHeads","record","idx","anchors","links","text","code","info","process","e","Map","resolveGridlist"],"mappings":"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"}